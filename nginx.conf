# nginx configuration for Mixpanel proxy
#
# Goals
# - Keep the config simple and well documented
# - Correctly forward the end-user IP when running on Render.com (which may sit behind Cloudflare)
# - Handle Cloudflare headers appropriately and follow nginx best practices
#
# How client IP is determined
# - Cloudflare sets CF-Connecting-IP to the original client IP.
# - We trust connections coming from Cloudflare ranges and Render's internal network.
# - We use real_ip_header CF-Connecting-IP so nginx treats the client IP as the real remote address
#   when requests come through these trusted proxies.
# - For headers we pass upstream, we use a $client_ip variable that prefers CF-Connecting-IP and
#   falls back to $remote_addr otherwise.

# Minimal events block
events {}

http {
    # Trust Cloudflare edge ranges (IPv4)
    # Reference: https://www.cloudflare.com/ips/
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;

    # Trust Cloudflare edge ranges (IPv6)
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;

    # Trust Render.com internal network (requests proxied within Render to your service)
    # Render docs commonly show 10.223.0.0/16 for internal hops.
    set_real_ip_from 10.223.0.0/16;

    # Use Cloudflare's header as the source of truth for client IP when coming from trusted ranges
    real_ip_header CF-Connecting-IP;
    real_ip_recursive on;

    # Prefer CF-Connecting-IP for X-Real-IP, otherwise fall back to the socket remote address
    map $http_cf_connecting_ip $client_ip {
        default $http_cf_connecting_ip;
        ""      $remote_addr;
    }

    # Debug access log format to help verify IP handling
    log_format debug_ips 'remote=$remote_addr realip=$realip_remote_addr cf=$http_cf_connecting_ip xff=$http_x_forwarded_for xreal=$http_x_real_ip';

    server {
        # Listen on IPv4 and IPv6, set as default server and raise backlog for high concurrency
        listen 80 default_server backlog=16384;
        listen [::]:80 default_server backlog=16384;

        # Emit debug access logs to stdout (visible in container logs)
        access_log /dev/stdout debug_ips;

        # Common proxy headers for all locations
        proxy_set_header X-Real-IP        $client_ip;                 # Prefer end-user IP
        proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for; # Append our hop
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Ensure proper SNI when proxying to HTTPS upstreams
        proxy_ssl_server_name on;

        # Mixpanel library files from CDN
        location /lib.min.js {
            proxy_pass https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js;
        }

        location /lib.js {
            proxy_pass https://cdn.mxpnl.com/libs/mixpanel-2-latest.js;
        }

        # Mixpanel decide endpoint
        location /decide {
            proxy_set_header Host decide.mixpanel.com;
            proxy_pass https://decide.mixpanel.com/decide;
        }

        # Default: Mixpanel tracking API
        location / {
            proxy_set_header Host api.mixpanel.com;

            # Optional debug headers to help troubleshoot IP forwarding end-to-end.
            # Comment these out in production if not needed.
            proxy_set_header X-Debug-RemoteAddr        $remote_addr;
            proxy_set_header X-Debug-RealIP            $realip_remote_addr;
            proxy_set_header X-Debug-CFConnectingIP    $http_cf_connecting_ip;
            proxy_set_header X-Debug-XForwardedFor     $http_x_forwarded_for;
            proxy_set_header X-Debug-XRealIP           $http_x_real_ip;

            proxy_pass https://api.mixpanel.com/;
        }
    }
}
