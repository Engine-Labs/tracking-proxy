events {}
http {
    # Render.com + Cloudflare real IP configuration
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    # Render.com specific IPs
    set_real_ip_from 76.76.19.0/24;
    set_real_ip_from 76.76.21.0/24;
    set_real_ip_from 76.76.22.0/24;
    set_real_ip_from 76.76.23.0/24;
    set_real_ip_from 76.76.24.0/24;
    set_real_ip_from 76.76.25.0/24;
    set_real_ip_from 76.76.26.0/24;
    set_real_ip_from 76.76.27.0/24;
    set_real_ip_from 76.76.28.0/24;
    set_real_ip_from 76.76.29.0/24;
    set_real_ip_from 76.76.30.0/24;
    set_real_ip_from 76.76.31.0/24;
    # Render.com internal IPs (10.223.x.x range)
    set_real_ip_from 10.223.0.0/16;
    real_ip_header CF-Connecting-IP;

    # Map to get the best available IP
    map $realip_remote_addr $client_ip {
        "" $remote_addr;
        default $realip_remote_addr;
    }

    # Debug logging format
    log_format debug_ips '$remote_addr - $realip_remote_addr - $client_ip - $http_cf_connecting_ip - $http_x_forwarded_for';
    server {
        listen 80 default backlog=16384;
        listen [::]:80 default backlog=16384;

        # Enable debug logging
        access_log /dev/stdout debug_ips;

        location /lib.min.js {
            proxy_set_header X-Real-IP $client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
            proxy_pass https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js;
        }

        location /lib.js {
            proxy_set_header X-Real-IP $client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
            proxy_pass https://cdn.mxpnl.com/libs/mixpanel-2-latest.js;
        }

        location /decide {
            proxy_set_header Host decide.mixpanel.com;
            proxy_set_header X-Real-IP $client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass https://decide.mixpanel.com/decide;
        }

        location / {
            proxy_set_header Host api.mixpanel.com;
            proxy_set_header X-Real-IP $client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Debug headers to see what IPs are being extracted
            proxy_set_header X-Debug-RemoteAddr $remote_addr;
            proxy_set_header X-Debug-RealIP $realip_remote_addr;
            proxy_set_header X-Debug-ClientIP $client_ip;
            proxy_set_header X-Debug-CFConnectingIP $http_cf_connecting_ip;
            proxy_set_header X-Debug-XForwardedFor $http_x_forwarded_for;

            proxy_pass https://api.mixpanel.com/;
        }
    }
}
