events {}
http {
    # Ensure request bodies are buffered in memory for logging
    client_body_buffer_size 1M;
    client_body_in_file_only off;
    client_body_in_single_buffer on;

    # Initialize lua package path
    init_by_lua_block {
        -- Initialize any lua code if needed
    }

    # Cloudflare real IP configuration
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 172.64.0.0/13;
    # Render.com internal IPs (10.223.x.x range)
    set_real_ip_from 10.223.0.0/16;
    real_ip_header CF-Connecting-IP;

    # Map to get the most reliable client IP
    map $http_cf_connecting_ip $client_ip {
        "" $remote_addr;
        default $http_cf_connecting_ip;
    }

    # Debug logging format to see all IP variables and request body
    # Using lua to capture request body before proxying
    log_format debug_ips '$remote_addr - $request_method $request_uri - $realip_remote_addr - $http_cf_connecting_ip - REQUEST_BODY: [$request_body_captured] - RESPONSE: $status $body_bytes_sent';

    server {
        listen 80 default backlog=16384;
        listen [::]:80 default backlog=16384;

        # Variable to hold captured request body (initialized empty)
        set $request_body_captured "";

        # Enable debug logging with request body
        # The request body will appear in raw nginx logs (stdout)
        access_log /dev/stdout debug_ips;

        # Also log request bodies to stderr for better visibility in Render logs
        error_log /dev/stderr info;

        location /lib.min.js {
            proxy_set_header X-Real-IP $client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
            proxy_pass https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js;
        }

        location /lib.js {
            proxy_set_header X-Real-IP $client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
            proxy_pass https://cdn.mxpnl.com/libs/mixpanel-2-latest.js;
        }

        location /decide {
            # Force nginx to read the request body
            lua_need_request_body on;

            # Capture request body using lua before proxying
            access_by_lua_block {
                local body = ngx.req.get_body_data()
                local captured_body = ""
                if body then
                    captured_body = body
                    ngx.var.request_body_captured = body
                else
                    local file = ngx.req.get_body_file()
                    if file then
                        local f = io.open(file, "r")
                        if f then
                            local content = f:read("*all")
                            f:close()
                            captured_body = content or ""
                            ngx.var.request_body_captured = captured_body
                        else
                            ngx.var.request_body_captured = ""
                        end
                    else
                        ngx.var.request_body_captured = ""
                    end
                end

                -- Log to stderr for visibility in Render logs
                if captured_body and captured_body ~= "" then
                    ngx.log(ngx.INFO, "REQUEST_BODY [" .. ngx.var.request_uri .. "]: " .. captured_body)
                end
            }

            proxy_set_header Host decide.mixpanel.com;
            proxy_set_header X-Real-IP $client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass https://decide.mixpanel.com/decide;
        }

        location / {
            # Force nginx to read the request body
            lua_need_request_body on;

            # Capture request body using lua before proxying
            access_by_lua_block {
                local body = ngx.req.get_body_data()
                local captured_body = ""
                if body then
                    captured_body = body
                    ngx.var.request_body_captured = body
                else
                    -- Try reading from file if body was written to temp file
                    local file = ngx.req.get_body_file()
                    if file then
                        local f = io.open(file, "r")
                        if f then
                            local content = f:read("*all")
                            f:close()
                            captured_body = content or ""
                            ngx.var.request_body_captured = captured_body
                        else
                            ngx.var.request_body_captured = ""
                        end
                    else
                        ngx.var.request_body_captured = ""
                    end
                end

                -- Log to stderr for visibility in Render logs
                if captured_body and captured_body ~= "" then
                    ngx.log(ngx.INFO, "REQUEST_BODY [" .. ngx.var.request_uri .. "]: " .. captured_body)
                end
            }

            proxy_set_header Host api.mixpanel.com;
            proxy_set_header X-Real-IP $client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Comprehensive debug headers
            proxy_set_header X-Debug-RemoteAddr $remote_addr;
            proxy_set_header X-Debug-RealIP $realip_remote_addr;
            proxy_set_header X-Debug-CFConnectingIP $http_cf_connecting_ip;
            proxy_set_header X-Debug-XForwardedFor $http_x_forwarded_for;
            proxy_set_header X-Debug-XRealIP $http_x_real_ip;
            proxy_set_header X-Debug-UserAgent $http_user_agent;
            proxy_set_header X-Debug-Referer $http_referer;
            proxy_set_header X-Debug-TrueClientIP $http_true_client_ip;
            proxy_set_header X-Debug-XForwardedForOriginal $http_x_forwarded_for_original;
            proxy_set_header X-Debug-AllHeaders "$http_user_agent $http_referer $http_cf_connecting_ip $http_x_forwarded_for $http_x_real_ip $http_true_client_ip";

            proxy_pass https://api.mixpanel.com/;
        }
    }
}
